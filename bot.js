const Discord = require('discord.js')
const config = require('./config_defaults')
const fs = require('fs')
const cbot = new Discord.Client()

const io = require('@pm2/io')

io.init({
  metrics: {
    network: {
      ports: true
    }
  }
})

/*/const mongoose = require('mongoose');
mongoose.connect('mongodb://127.0.0.1:27017/test', { useNewUrlParser: true });

mongoose.connection.once('open', function(){
    console.log('–ë–æ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.')
}).on('error', function(error){
    console.log('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error)
})
/*/

const rl = require('readline').createInterface({
    input: process.stdin,
    output: process.stdout
})

cbot.login(config.token)

cbot.on('ready', ready => {
    console.log(`${cbot.user.tag}:\x1b[32mON\x1b[0m`)

    cbot.user.setActivity("lancdl.github.io/callback/")

    cbot.users.get(config.dev_id).send('–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω.')

    rl.on('line', function(guildsSize) {
        if (guildsSize !== "guilds") {
            return;
        }
        console.log(`–ë–æ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ ${cbot.guilds.size} —Å–µ—Ä–≤–µ—Ä–∞—Ö.\n${cbot.guilds.map(g=>g.name).join("\n")}`)
    })

    rl.on('line', function(usersSize) {
        if (usersSize !== "users") {
            return;
        }
        console.log(`–ö –±–æ—Ç—É –ø–æ–¥–∫–ª—é—á–µ–Ω–æ ${cbot.users.size} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.\n${cbot.users.map(u=>u.tag).join("\n")}`)
    })
})

cbot.on("message", async message => {
    let prefix = "!"

    if (message.channel.type === "dm") {
        if (message.author.id !== config.bot_id) {
            return console.log(`${message.author.tag} (${message.author.id}) –ø—ã—Ç–∞–ª—Å—è –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞. –í–æ—Ç —á—Ç–æ –æ–Ω –ø—ã—Ç–∞–ª—Å—è —Å–∫–∞–∑–∞—Ç—å: ${message.content}`);
        }
    }

    if(message.content === `${prefix}guilds`) {
        await message.delete()

        if(message.author.id !== config.dev_id) {
            return;
        }
        return message.author.send(`–ë–æ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ ${cbot.guilds.size} —Å–µ—Ä–≤–µ—Ä–∞—Ö.\n${cbot.guilds.map(g=>g.name).join("\n")}`)
    }

    if(message.content === `${prefix}users`) {
        await message.delete()

        if(message.author.id !== config.dev_id) {
            return;
        }
        return message.author.send(`–ö –±–æ—Ç—É –ø–æ–¥–∫–ª—é—á–µ–Ω–æ ${cbot.users.size} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.\n${cbot.users.map(u=>u.tag).join("\n")}`)
    }

    if (message.content === `${prefix}–ø—Ä–æ–≤–µ—Ä–∫–∞`) {
        await message.delete()

        if (!message.member.guild.me.hasPermission([8])) {
            if (message.author.id !== message.guild.ownerID) {
                var noneOwnerEmbed = new Discord.RichEmbed()
                    .setColor("#fcba03")
                    .setTitle("‚ö†")
                    .setDescription("–ù—É–∂–Ω–æ –±—ã—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —Å–µ—Ä–≤–µ—Ä–∞.")
                return message.author.send(noneOwnerEmbed), console.log(`${message.author.tag} (${message.author.id}) –ø—ã—Ç–∞–ª—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–æ—Ç–∞ –Ω–µ —è–≤–ª—è—è—Å—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º.`);
            } else {
                return message.author.send("–ë–æ—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ `ADMINISTRATOR`.\n–í –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –±–æ—Ç –Ω–µ —Å–º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—É `!–∏–Ω—Ñ–æ`."), console.log(`${message.author.tag} (${message.author.id}) –ø—Ä–æ–≤–µ—Ä–∏–ª –±–æ—Ç–∞. –†–µ–∑—É–ª—å—Ç–∞—Ç: –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ.`);
            }
        }

        if (message.member.guild.me.hasPermission([8])) {
            if (message.author.id !== message.guild.ownerID) {
                var noneOwnerEmbed = new Discord.RichEmbed()
                    .setColor("#fcba03")
                    .setTitle("‚ö†")
                    .setDescription("–ù—É–∂–Ω–æ –±—ã—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —Å–µ—Ä–≤–µ—Ä–∞.")
                return message.author.send(noneOwnerEmbed), console.log(`${message.author.tag} (${message.author.id}) –ø—ã—Ç–∞–ª—Å—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–æ—Ç–∞ –Ω–µ —è–≤–ª—è—è—Å—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º.`);
            } else {
                return message.author.send("–ë–æ—Ç –≤–ø–æ—Ä—è–¥–∫–µ!"), console.log(`${message.author.tag} (${message.author.id}) –ø—Ä–æ–≤–µ—Ä–∏–ª –±–æ—Ç–∞. –†–µ–∑—É–ª—å—Ç–∞—Ç: –ë–æ—Ç –≤–ø–æ—Ä—è–¥–∫–µ!`);
            }
        }
    }

    if (message.content === `${prefix}–∏–Ω—Ñ–æ`) {
        await message.delete();

        if (message.author.id !== message.guild.ownerID) {
            var noneOwnerEmbed = new Discord.RichEmbed()
                .setColor("#fcba03")
                .setTitle("‚ö†")
                .setDescription("–ù—É–∂–Ω–æ –±—ã—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —Å–µ—Ä–≤–µ—Ä–∞.")
            return message.author.send(noneOwnerEmbed), console.log(`${message.author.tag} (${message.author.id}) –ø—ã—Ç–∞–ª—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä–≤–µ—Ä–µ –Ω–µ —è–≤–ª—è—è—Å—å –≤–ª–∞–¥–µ–ª—å—Ü–µ–º.`);
        }
        if (message.author.id === message.guild.ownerID) {
            console.log(`–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —Å–µ—Ä–≤–µ—Ä—É ${message.guild.name}/${message.guild.id}`);
            console.log(message.guild)
            var serverEmbed = new Discord.RichEmbed()
                .setColor("#fac534")
                .setTitle("üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ —Å–µ—Ä–≤–µ—Ä")
                .setThumbnail(message.guild.iconURL)
                .addField("–ù–∞–∑–≤–∞–Ω–∏–µ", message.guild.name)
                .addField("–ê–∫—Ä–æ–Ω–∏–º", message.guild.nameAcronym)
                .addField("ID —Å–µ—Ä–≤–µ—Ä–∞", message.guild.id)
                .addField("–†–µ–≥–∏–æ–Ω", message.guild.region)
                .addBlankField()
                .addField("–ö–æ–ª-–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π", message.guild.messages)
                .addField("–ö–æ–ª-–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", message.guild.memberCount)
                .addField("–ö–æ–ª-–≤–æ –æ–Ω–ª–∞–π–Ω —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", message.guild.members.filter(m => m.presence.status === 'online').size)
                .addField("–ö–æ–ª-–≤–æ —Ä–æ–ª–µ–π", message.guild.roles.size)
                .addField("–ö–æ–ª-–≤–æ —ç–º–æ–¥–∂–∏", message.guild.emojis.size)
                .addField("–ö–æ–ª-–≤–æ –∫–∞–Ω–∞–ª–æ–≤", message.guild.channels.size)
                .addBlankField()
                .addField("mfaLevel", message.guild.mfaLevel)
                .addField("–£—Ä–æ–≤–µ–Ω—å –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏", message.guild.verificationLevel)
                .addField("–ù–∞–ª–∏—á–∏–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏", message.guild.verified)
            return message.author.send(serverEmbed)
        }
    }
})

fs.readdir('./events', (err, files) => {
    if (err) return console.error;
    files.forEach(file => {
        if (!file.endsWith('.js')) return;
        const evt = require(`./events/${file}`)
        let evtName = file.split('.')[0]
        console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω –∏–≤–µ–Ω—Ç '${evtName}'`)
        cbot.on(evtName, evt.bind(null, cbot))
    })
})

/*/
cbot.on('guildMemberAdd', member => {
    console.log(`${member.user.tag} –∑–∞—à–µ–ª –Ω–∞ ${member.guild.name}`)
        var joinEmbed = new Discord.RichEmbed()
            .setColor("#ff4242")
            .setTitle("üíñ")
            .setDescription(`–°–µ—Ä–≤–µ—Ä: ${member.guild.name}`)
            .addField(`${member.user.tag}`, " –∑–∞—à–µ–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä", true)
            .addField("–ö–æ–ª-–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", member.guild.memberCount)
        member.guild.owner.send(joinEmbed)
        if(member.guild.id === "403271253290647562"){
            let myRole = member.guild.roles.find(role => role.name === "–§–∞–ª–∫–æ–Ω–æ–≤–µ—Ü")
            return member.addRole(myRole).catch(console.error);
        }
})
/*/
/*/
cbot.on('guildCreate', guild => {
    console.log(`–¢–µ–ø–µ—Ä—å —è –º–æ–¥–µ—Ä–∏—Ä—É—é ${guild.name}`)
        var guildCreateEmbed = new Discord.RichEmbed()
            .setColor("#b87dff")
            .addField("üíå", "–ü—Ä–∏–≤–µ—Ç! –û—Ç–Ω—ã–Ω–µ —è –±—É–¥—É —Å–æ–æ–±—â–∞—Ç—å —Ç–µ–±–µ –æ –Ω–æ–≤—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö –Ω–∞ —Ç–≤–æ–µ–º —Å–µ—Ä–≤–µ—Ä–µ!")
            .addField("‚öô", "–ù–µ–º–Ω–æ–≥–æ –æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ\n–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–≤–æ—ë–º —Å–µ—Ä–≤–µ—Ä–µ –Ω–∞–ø–∏—à–∏ –∫–æ–º–∞–Ω–¥—É `!–∏–Ω—Ñ–æ` (–í–ê–ñ–ù–û! –ü–∏—Å–∞—Ç—å –Ω—É–∂–Ω–æ –Ω–∞ —Å–≤–æ—ë–º —Å–µ—Ä–≤–µ—Ä–µ, —á—Ç–æ–±—ã –±–æ—Ç –ø–æ–Ω—è–ª –æ –∫–∞–∫–æ–º —Å–µ—Ä–≤–µ—Ä–µ –∏–¥—ë—Ç —Ä–µ—á—å.), –∞ –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –±–æ—Ç –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å —Å–∞–º (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –í–∞–º –≤ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è).")
        guild.owner.send(guildCreateEmbed)            
})
/*/
/*/
cbot.on('guildDelete', guild => {
    console.log(`${guild.name} –æ—Ç–∫–ª—é—á–∏–ª–∏ –Ω–∞—Å...`)
        var guildDeleteEmbed = new Discord.RichEmbed()
            .setColor("#b87dff")
            .setTitle("ü§î")
            .addField("–ú–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–ª–∞ –∫–∞–∫–∞—è-—Ç–æ –æ—à–∏–±–∫–∞?", "–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –º–æ–¥–µ—Ä–∞—Ü–∏–∏ —Å –ø–æ–º–æ—â—å—é –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞?\n–ï—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞, —Ç–æ –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å –±–æ—Ç–∞ —Å–Ω–æ–≤–∞ –ø–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ: `—Å—Å—ã–ª–∫–∞`")
        guild.owner.send(guildDeleteEmbed)
})
/*/
/*/
cbot.on('guildMemberRemove', member => {
    console.log(`${member.user.tag} –≤—ã—à–µ–ª/–±—ã–ª –∑–∞–±–∞–Ω–µ–Ω/–∫–∏–∫–Ω—É—Ç –Ω–∞ ${member.guild.name}`)
        var removeEmbed = new Discord.RichEmbed()
            .setColor("#ff4242")
            .setTitle("üíî")
            .setDescription(`–°–µ—Ä–≤–µ—Ä: ${member.guild.name}`)
            .addField(`${member.user.tag}`, " –ø–æ–∫–∏–Ω—É–ª –Ω–∞—Å/–±—ã–ª –∑–∞–±–∞–Ω–µ–Ω/–∫–∏–∫–Ω—É—Ç", true)
            .addField("–ö–æ–ª-–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤", member.guild.memberCount)
        member.guild.owner.send(removeEmbed)
})
/*/
/*/
cbot.on('guildUpdate', (oldGuild, newGuild) => {
    console.log(`–ù–∞ ${newGuild.name} –ø—Ä–æ–∏–∑–æ—à–ª–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ`)
    var guildUpdateEmbed = new Discord.RichEmbed()
        .setColor("#4287f5")
        .setTitle("‚öô")
        .setDescription(newGuild.name)
        .addField("oldName", oldGuild.name)
        .addField("oldNameAcronym", oldGuild.nameAcronym)
        .addField("oldRegion", oldGuild.region)
        .addField("oldVerificationLevel", oldGuild.verificationLevel)
        .addField("oldMFALevel", oldGuild.mfaLevel)
        .addField("oldVerified", oldGuild.verified)
        .addBlankField()
        .addField("newName", newGuild.name)
        .addField("newNameAcronym", newGuild.nameAcronym)
        .addField("newRegion", newGuild.region)
        .addField("newVerificationLevel", newGuild.verificationLevel)
        .addField("newMFALevel", newGuild.mfaLevel)
        .addField("newVerified", newGuild.verified)
    newGuild.owner.send(guildUpdateEmbed)
})
/*/
/*/
cbot.on('roleCreate', role => {
    console.log(`–ù–∞ ${role.guild.name} –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ —Ä–æ–ª—å ${role.name}`)
    var roleCreateEmbed = new Discord.RichEmbed()
        .setColor("#f5ad42")
        .setTitle("üîî")
        .setDescription(role.guild.name)
        .addField("–°–æ–∑–¥–∞–Ω–∞ —Ä–æ–ª—å", role.name)
    role.guild.owner.send(roleCreateEmbed)
})
/*/
/*/
cbot.on('roleDelete', role => {
    console.log(`–ù–∞ ${role.guild.name} –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ —Ä–æ–ª—å ${role.name}`)
    var roleDeleteEmbed = new Discord.RichEmbed()
        .setColor("#f5ad42")
        .setTitle("üîî")
        .setDescription(role.guild.name)
        .addField("–£–¥–∞–ª–µ–Ω–∞ —Ä–æ–ª—å", role.name)
    role.guild.owner.send(roleDeleteEmbed)
})
/*/
/*/
cbot.on('roleUpdate', (oldRole, newRole) => {
    console.log(`–ù–∞ ${newRole.guild.name} –±—ã–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ —Ä–æ–ª—å ${oldRole.name} –Ω–∞ ${newRole.name}`)
    var roleUpdateEmbed = new Discord.RichEmbed()
        .setColor("#f5ad42")
        .setTitle("üîî")
        .setDescription(newRole.guild.name)
        .addField("oldName", oldRole.name)
        .addField("oldPermissions", oldRole.permissions)
        .addField("oldColor", oldRole.color)
        .addBlankField()
        .addField("newName", newRole.name)
        .addField("newColor", newRole.color)
        .addField("newPermissions", newRole.permissions)
    newRole.guild.owner.send(roleUpdateEmbed)   
})
/*/

cbot.on('guildBanAdd', guild => {

})

cbot.on('guildBanRemove', guild => {

})